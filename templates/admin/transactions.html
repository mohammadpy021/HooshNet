{% extends "admin/base.html" %}

{% block page_title %}ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù„ÛŒ{% endblock %}
{% block page_subtitle %}Ù„ÛŒØ³Øª Ùˆ ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Actions Bar -->
    <div class="card" style="margin-bottom: var(--sp-xl);">
        <div
            style="display: flex; flex-wrap: wrap; gap: var(--sp-md); justify-content: space-between; align-items: center;">

            <!-- Stats Summary -->
            <div style="display: flex; gap: var(--sp-lg); align-items: center; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: var(--sp-sm);">
                    <div
                        style="width: 40px; height: 40px; border-radius: var(--radius-lg); background: rgba(99, 102, 241, 0.1); color: var(--p-info); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <div>
                        <div style="font-weight: 700;">{{ stats.total or 0 }}</div>
                        <div style="font-size: 0.8rem; color: var(--p-text-muted);">Ú©Ù„ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</div>
                    </div>
                </div>

                <div style="width: 1px; height: 30px; background: var(--border-color);"></div>

                <div style="display: flex; align-items: center; gap: var(--sp-sm);">
                    <div
                        style="width: 40px; height: 40px; border-radius: var(--radius-lg); background: rgba(16, 185, 129, 0.1); color: var(--p-success); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div>
                        <div style="font-weight: 700;">{{ stats.successful or 0 }}</div>
                        <div style="font-size: 0.8rem; color: var(--p-text-muted);">Ù…ÙˆÙÙ‚</div>
                    </div>
                </div>

                <div style="width: 1px; height: 30px; background: var(--border-color);"></div>

                <div style="display: flex; align-items: center; gap: var(--sp-sm);">
                    <div
                        style="width: 40px; height: 40px; border-radius: var(--radius-lg); background: rgba(245, 158, 11, 0.1); color: var(--p-warning); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div>
                        <div style="font-weight: 700;">{{ stats.pending or 0 }}</div>
                        <div style="font-size: 0.8rem; color: var(--p-text-muted);">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div>
                    </div>
                </div>
                
                {% if stats.receipts_pending and stats.receipts_pending > 0 %}
                <div style="width: 1px; height: 30px; background: var(--border-color);"></div>
                <div style="display: flex; align-items: center; gap: var(--sp-sm);">
                    <div
                        style="width: 40px; height: 40px; border-radius: var(--radius-lg); background: rgba(236, 72, 153, 0.1); color: #ec4899; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                    <div>
                        <div style="font-weight: 700;">{{ stats.receipts_pending or 0 }}</div>
                        <div style="font-size: 0.8rem; color: var(--p-text-muted);">Ø±Ø³ÛŒØ¯ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Search -->
            <div
                style="flex: 1; min-width: 300px; display: flex; align-items: center; gap: var(--sp-sm); background: var(--p-bg-main); padding: var(--sp-sm) var(--sp-md); border-radius: var(--radius-lg); border: 1px solid var(--border-color);">
                <i class="fas fa-search" style="color: var(--p-text-muted);"></i>
                <input type="text" id="searchInput" placeholder="Ø¬Ø³ØªØ¬Ùˆ (Ø¢ÛŒØ¯ÛŒØŒ Ù…Ø¨Ù„ØºØŒ ÛŒÙˆØ²Ø±Ù†ÛŒÙ…...)" value="{{ search }}"
                    style="flex: 1; color: var(--p-text-main);" onkeypress="handleSearchKeypress(event)">
                {% if search %}
                <button onclick="clearSearch()" style="color: var(--p-text-muted); cursor: pointer;"><i
                        class="fas fa-times"></i></button>
                {% endif %}
            </div>

            <div style="display: flex; gap: var(--sp-sm);">
                <select id="statusFilter" class="form-control" onchange="filterByStatus()" style="min-width: 150px;">
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>Ù‡Ù…Ù‡ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</option>
                    <option value="successful" {% if status_filter == 'successful' %}selected{% endif %}>ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙÙ‚</option>
                    <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</option>
                </select>
                <button class="btn btn-primary" onclick="performSearch()">
                    <i class="fas fa-search"></i>
                    <span>Ø¬Ø³ØªØ¬Ùˆ</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Transactions Grid -->
    <div class="grid-3">
        {% if invoices %}
        {% for invoice in invoices %}
        <div class="card transaction-card">
            <div class="card-header"
                style="margin-bottom: var(--sp-md); border-bottom: 1px solid var(--border-color); padding-bottom: var(--sp-md);">
                <div style="display: flex; gap: var(--sp-md); align-items: center;">
                    <div style="position: relative;">
                        <div
                            style="width: 50px; height: 50px; border-radius: var(--radius-lg); background: var(--p-bg-hover); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: {% if invoice.status == 'paid' or invoice.status == 'completed' %}var(--p-success){% elif invoice.status == 'pending' %}var(--p-warning){% else %}var(--p-error){% endif %};">
                            {% if invoice.status == 'paid' or invoice.status == 'completed' %}
                            <i class="fas fa-check-circle"></i>
                            {% elif invoice.status == 'pending' %}
                            <i class="fas fa-clock"></i>
                            {% else %}
                            <i class="fas fa-times-circle"></i>
                            {% endif %}
                        </div>
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 800; font-size: 1rem; margin-bottom: 2px;">#{{ invoice.id }}</div>
                        <div style="font-size: 0.8rem; color: var(--p-text-muted);">
                            {% if invoice.purchase_type == 'plan' %}Ù¾Ù„Ù†{% elif invoice.purchase_type == 'gigabyte'
                            %}Ø­Ø¬Ù…{% else %}{{ invoice.purchase_type }}{% endif %}
                        </div>
                    </div>
                    <div style="text-align: left;">
                        <div
                            style="font-weight: 800; font-size: 1.1rem; color: {% if invoice.status == 'paid' or invoice.status == 'completed' %}var(--p-success){% elif invoice.status == 'pending' %}var(--p-warning){% else %}var(--p-error){% endif %};">
                            {{ "{:,}".format(invoice.amount) }} <span style="font-size: 0.7rem;">ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                    </div>
                </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: var(--sp-sm);">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: var(--sp-sm); background: var(--p-bg-hover); border-radius: var(--radius-md);">
                    <div style="display: flex; align-items: center; gap: var(--sp-sm);">
                        <i class="fas fa-user" style="color: var(--p-text-muted); font-size: 0.8rem;"></i>
                        <span style="font-size: 0.8rem; color: var(--p-text-muted);">Ú©Ø§Ø±Ø¨Ø±</span>
                    </div>
                    <div style="text-align: left;">
                        <div style="font-weight: 700; font-size: 0.9rem;">{{ invoice.first_name or '---' }}</div>
                        <div style="font-size: 0.7rem; color: var(--p-text-muted);">@{{ invoice.username or '---' }}
                        </div>
                    </div>
                </div>

                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: var(--sp-sm); background: var(--p-bg-hover); border-radius: var(--radius-md);">
                    <div style="display: flex; align-items: center; gap: var(--sp-sm);">
                        <i class="fas fa-server" style="color: var(--p-text-muted); font-size: 0.8rem;"></i>
                        <span style="font-size: 0.8rem; color: var(--p-text-muted);">Ù¾Ù†Ù„</span>
                    </div>
                    <span style="font-weight: 700; color: var(--p-info);">{{ invoice.panel_name }}</span>
                </div>

                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: var(--sp-sm); background: var(--p-bg-hover); border-radius: var(--radius-md);">
                    <div style="display: flex; align-items: center; gap: var(--sp-sm);">
                        <i class="fas fa-calendar" style="color: var(--p-text-muted); font-size: 0.8rem;"></i>
                        <span style="font-size: 0.8rem; color: var(--p-text-muted);">ØªØ§Ø±ÛŒØ®</span>
                    </div>
                    <div style="text-align: left;">
                        <div style="font-weight: 700; font-size: 0.9rem;">{{ invoice.created_at.strftime('%Y-%m-%d') if
                            invoice.created_at else '-' }}</div>
                        <div style="font-size: 0.7rem; color: var(--p-text-muted);">{{
                            invoice.created_at.strftime('%H:%M:%S') if invoice.created_at else '' }}</div>
                    </div>
                </div>

                {% if invoice.status == 'pending' and invoice.order_id %}
                <button class="btn btn-sm btn-outline" style="width: 100%; margin-top: var(--sp-sm);"
                    onclick="checkTransactionStatus({{ invoice.id }}, '{{ invoice.order_id }}', this)">
                    <i class="fas fa-sync-alt"></i>
                    Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª
                </button>
                {% endif %}
                
                {% if invoice.receipt_path %}
                <button class="btn btn-sm btn-info" style="width: 100%; margin-top: var(--sp-sm); background: var(--p-info); border-color: var(--p-info); color: white;"
                    onclick="showReceiptModal({{ invoice.id }}, '{{ invoice.receipt_path }}', '{{ invoice.receipt_status }}')">
                    <i class="fas fa-file-invoice"></i>
                    Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±Ø³ÛŒØ¯
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="card" style="grid-column: 1 / -1; text-align: center; padding: var(--sp-3xl);">
            <i class="fas fa-receipt"
                style="font-size: 3rem; color: var(--p-bg-active); margin-bottom: var(--sp-lg);"></i>
            <h3 style="margin-bottom: var(--sp-sm);">ØªØ±Ø§Ú©Ù†Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h3>
            <p class="text-muted">Ù‡ÛŒÚ† ØªØ±Ø§Ú©Ù†Ø´ÛŒ Ø¨Ø§ Ù…Ø´Ø®ØµØ§Øª ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.</p>
        </div>
        {% endif %}
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="card"
        style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--sp-md); margin-top: var(--sp-xl);">
        <div class="text-muted" style="font-size: 0.9rem;">
            Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ <strong>{{ page }}</strong> Ø§Ø² <strong>{{ total_pages }}</strong>
        </div>
        <div style="display: flex; gap: var(--sp-sm);">
            {% if page > 1 %}
            <a href="?page={{ page - 1 }}{% if search %}&search={{ search }}{% endif %}"
                class="btn btn-sm btn-secondary">
                <i class="fas fa-chevron-right"></i>
                Ù‚Ø¨Ù„ÛŒ
            </a>
            {% endif %}

            {% if page < total_pages %} <a href="?page={{ page + 1 }}{% if search %}&search={{ search }}{% endif %}"
                class="btn btn-sm btn-secondary">
                Ø¨Ø¹Ø¯ÛŒ
                <i class="fas fa-chevron-left"></i>
                </a>
                {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
    function handleSearchKeypress(event) {
        if (event.key === 'Enter') {
            performSearch();
        }
    }

    function performSearch() {
        const query = document.getElementById('searchInput').value;
        window.location.href = `?search=${encodeURIComponent(query)}`;
    }

    function clearSearch() {
        window.location.href = window.location.pathname;
    }

    function filterByStatus() {
        const status = document.getElementById('statusFilter').value;
        const search = new URLSearchParams(window.location.search).get('search') || '';
        let url = '/admin/transactions?status=' + status;
        if (search) {
            url += '&search=' + encodeURIComponent(search);
        }
        window.location.href = url;
    }

    async function checkTransactionStatus(id, orderId, btn) {
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...';
        btn.disabled = true;

        try {
            const response = await apiCall(`/api/admin/transactions/${id}/check`, {
                method: 'POST',
                body: JSON.stringify({ order_id: orderId })
            });

            if (response.status === 'paid' || response.status === 'completed') {
                showToast('ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡ Ø§Ø³Øª', 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast('ØªØ±Ø§Ú©Ù†Ø´ Ù‡Ù†ÙˆØ² Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª', 'warning');
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        } catch (error) {
            console.error(error);
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    }

    function showReceiptModal(invoiceId, receiptPath, receiptStatus) {
        document.getElementById('receiptImage').src = '/static/receipts/' + receiptPath;
        document.getElementById('receiptInvoiceId').textContent = '#' + invoiceId;
        const statusText = receiptStatus === 'pending_approval' ? 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯' : 
                          receiptStatus === 'approved' ? 'ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡' : 
                          receiptStatus === 'rejected' ? 'Ø±Ø¯ Ø´Ø¯Ù‡' : 'Ù†Ø§Ù…Ø´Ø®Øµ';
        document.getElementById('receiptStatus').textContent = statusText;
        
        const approveBtn = document.getElementById('approveReceiptBtn');
        const rejectBtn = document.getElementById('rejectReceiptBtn');
        
        // Disable buttons if already approved or rejected
        if (receiptStatus === 'approved' || receiptStatus === 'rejected') {
            approveBtn.disabled = true;
            approveBtn.style.opacity = '0.5';
            approveBtn.style.cursor = 'not-allowed';
            approveBtn.onclick = null;
            
            rejectBtn.disabled = true;
            rejectBtn.style.opacity = '0.5';
            rejectBtn.style.cursor = 'not-allowed';
            rejectBtn.onclick = null;
        } else {
            approveBtn.disabled = false;
            approveBtn.style.opacity = '1';
            approveBtn.style.cursor = 'pointer';
            approveBtn.onclick = () => approveReceipt(invoiceId);
            
            rejectBtn.disabled = false;
            rejectBtn.style.opacity = '1';
            rejectBtn.style.cursor = 'pointer';
            rejectBtn.onclick = () => rejectReceipt(invoiceId);
        }
        
        document.getElementById('receiptModal').style.display = 'flex';
    }

    function closeReceiptModal() {
        document.getElementById('receiptModal').style.display = 'none';
    }

    async function approveReceipt(invoiceId) {
        if (!confirm('Ø¢ÛŒØ§ Ø§Ø² ØªØ§ÛŒÛŒØ¯ Ø§ÛŒÙ† Ø±Ø³ÛŒØ¯ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) return;
        
        try {
            const response = await apiCall(`/api/admin/transactions/${invoiceId}/receipt/approve`, {
                method: 'POST'
            });
            showToast('Ø±Ø³ÛŒØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØ§ÛŒÛŒØ¯ Ø´Ø¯', 'success');
            closeReceiptModal();
            setTimeout(() => window.location.reload(), 1000);
        } catch (error) {
            console.error(error);
            showToast(error.message || 'Ø®Ø·Ø§ Ø¯Ø± ØªØ§ÛŒÛŒØ¯ Ø±Ø³ÛŒØ¯', 'error');
        }
    }

    async function rejectReceipt(invoiceId) {
        if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø±Ø¯ Ø§ÛŒÙ† Ø±Ø³ÛŒØ¯ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) return;
        
        try {
            const response = await apiCall(`/api/admin/transactions/${invoiceId}/receipt/reject`, {
                method: 'POST'
            });
            showToast('Ø±Ø³ÛŒØ¯ Ø±Ø¯ Ø´Ø¯', 'success');
            closeReceiptModal();
            setTimeout(() => window.location.reload(), 1000);
        } catch (error) {
            console.error(error);
            showToast(error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø±Ø¯ Ø±Ø³ÛŒØ¯', 'error');
        }
    }
</script>

<!-- Receipt Modal -->
<div id="receiptModal" class="modal-overlay" style="display: none;">
    <div class="modal-card" style="max-width: 600px;">
        <div class="card-header" style="border-bottom: 1px solid var(--border-color); margin-bottom: var(--sp-lg); padding-bottom: var(--sp-md);">
            <div class="card-title">
                <i class="fas fa-file-invoice" style="color: var(--p-info);"></i>
                Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±Ø³ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª
            </div>
            <button onclick="closeReceiptModal()" class="close-btn"><i class="fas fa-times"></i></button>
        </div>
        <div style="padding: 0 var(--sp-lg);">
            <div style="background: var(--p-bg-hover); border-radius: var(--radius-md); padding: var(--sp-md); margin-bottom: var(--sp-lg);">
                <div style="display: flex; justify-content: space-between; margin-bottom: var(--sp-sm);">
                    <span style="color: var(--p-text-muted);">ğŸ”¢ Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±:</span>
                    <span style="font-weight: 700; color: var(--p-text-main);" id="receiptInvoiceId">-</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding-top: var(--sp-sm); border-top: 1px solid var(--border-color);">
                    <span style="color: var(--p-text-muted);">ğŸ“Š ÙˆØ¶Ø¹ÛŒØª:</span>
                    <span style="font-weight: 700; color: var(--p-warning);" id="receiptStatus">-</span>
                </div>
            </div>
            <div style="text-align: center; margin-bottom: var(--sp-lg);">
                <img id="receiptImage" src="" alt="Receipt" style="max-width: 100%; border-radius: var(--radius-lg); border: 1px solid var(--border-color); box-shadow: var(--shadow-lg);">
            </div>
            <div style="display: flex; gap: var(--sp-md);">
                <button type="button" class="btn btn-secondary" onclick="closeReceiptModal()" style="flex: 1;">Ø¨Ø³ØªÙ†</button>
                <button type="button" class="btn btn-success" id="approveReceiptBtn" style="flex: 1; background: var(--p-success); border-color: var(--p-success); color: white;">
                    <i class="fas fa-check"></i> ØªØ§ÛŒÛŒØ¯ Ø±Ø³ÛŒØ¯
                </button>
                <button type="button" class="btn btn-danger" id="rejectReceiptBtn" style="flex: 1; background: var(--p-error); border-color: var(--p-error); color: white;">
                    <i class="fas fa-times"></i> Ø±Ø¯ Ø±Ø³ÛŒØ¯
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(8px);
        overflow-y: auto;
        padding: var(--sp-lg);
    }

    .modal-card {
        background: var(--p-bg-main);
        border-radius: var(--radius-xl);
        width: 100%;
        max-width: 600px;
        padding: var(--sp-xl);
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-xl);
        animation: modalSlideIn 0.3s ease;
        position: relative;
        margin: auto;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}