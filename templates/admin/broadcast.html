{% extends "admin/base.html" %}

{% block page_title %}Ù‡Ù…Ú¯Ø§Ù†ÛŒ{% endblock %}
{% block page_subtitle %}Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ ØªÙ…Ø§Ù… Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø±Ø¨Ø§Øª{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="card" style="max-width: 800px; margin: 0 auto;">
        <div class="card-header"
            style="margin-bottom: var(--sp-lg); padding-bottom: var(--sp-md); border-bottom: 1px solid var(--border-color);">
            <div style="display: flex; gap: var(--sp-md); align-items: center;">
                <div
                    style="width: 48px; height: 48px; border-radius: var(--radius-lg); background: rgba(99, 102, 241, 0.1); color: var(--p-primary); display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                    <i class="fas fa-paper-plane"></i>
                </div>
                <div>
                    <div style="font-weight: 800; font-size: 1.2rem;">Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ</div>
                    <div style="font-size: 0.9rem; color: var(--p-text-muted);">Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø¨Ù‡ ØªÙ…Ø§Ù… Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„ Ø±Ø¨Ø§Øª Ø§Ø±Ø³Ø§Ù„
                        Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯</div>
                </div>
            </div>
        </div>

        <form id="broadcastForm" onsubmit="sendBroadcast(event)">
            <!-- Filter Selection -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-filter" style="color: var(--p-primary);"></i>
                    Ø§Ù†ØªØ®Ø§Ø¨ Ú¯Ø±ÙˆÙ‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
                    <span style="color: var(--p-error);">*</span>
                </label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--sp-md);">
                    <label class="filter-option" style="cursor: pointer;">
                        <input type="radio" name="user_filter" value="all" checked style="display: none;" onchange="updateFilterInfo()">
                        <div class="filter-card" data-filter="all">
                            <div style="font-size: 2rem; margin-bottom: var(--sp-sm);">ğŸ‘¥</div>
                            <div style="font-weight: 700; margin-bottom: var(--sp-xs);">Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</div>
                            <div style="font-size: 0.8rem; color: var(--p-text-muted);">Ú©Ù„ Ø¯ÛŒØªØ§Ø¨ÛŒØ³</div>
                        </div>
                    </label>
                    <label class="filter-option" style="cursor: pointer;">
                        <input type="radio" name="user_filter" value="active" style="display: none;" onchange="updateFilterInfo()">
                        <div class="filter-card" data-filter="active">
                            <div style="font-size: 2rem; margin-bottom: var(--sp-sm);">âœ…</div>
                            <div style="font-weight: 700; margin-bottom: var(--sp-xs);">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„</div>
                            <div style="font-size: 0.8rem; color: var(--p-text-muted);">Ø§Ø´ØªØ±Ø§Ú© ÙØ¹Ø§Ù„ Ø¯Ø§Ø±Ù†Ø¯</div>
                        </div>
                    </label>
                    <label class="filter-option" style="cursor: pointer;">
                        <input type="radio" name="user_filter" value="inactive" style="display: none;" onchange="updateFilterInfo()">
                        <div class="filter-card" data-filter="inactive">
                            <div style="font-size: 2rem; margin-bottom: var(--sp-sm);">â¸ï¸</div>
                            <div style="font-weight: 700; margin-bottom: var(--sp-xs);">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ØºÛŒØ±ÙØ¹Ø§Ù„</div>
                            <div style="font-size: 0.8rem; color: var(--p-text-muted);">Ø§Ø´ØªØ±Ø§Ú© ØªÙ…ÙˆÙ… Ø´Ø¯Ù‡</div>
                        </div>
                    </label>
                    <label class="filter-option" style="cursor: pointer;">
                        <input type="radio" name="user_filter" value="no_purchase" style="display: none;" onchange="updateFilterInfo()">
                        <div class="filter-card" data-filter="no_purchase">
                            <div style="font-size: 2rem; margin-bottom: var(--sp-sm);">ğŸ›’</div>
                            <div style="font-weight: 700; margin-bottom: var(--sp-xs);">Ø¨Ø¯ÙˆÙ† Ø®Ø±ÛŒØ¯</div>
                            <div style="font-size: 0.8rem; color: var(--p-text-muted);">Ù‡Ù†ÙˆØ² Ø®Ø±ÛŒØ¯ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø¯Ø§Ø¯Ù‡â€ŒØ§Ù†Ø¯</div>
                        </div>
                    </label>
                </div>
                <div id="filterInfo" style="margin-top: var(--sp-md); padding: var(--sp-md); background: var(--p-bg-hover); border-radius: var(--radius-md); border: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: var(--sp-sm);">
                        <i class="fas fa-info-circle" style="color: var(--p-info);"></i>
                        <span style="font-size: 0.9rem; color: var(--p-text-main);" id="filterInfoText">Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†...</span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-edit" style="color: var(--p-primary);"></i>
                    Ù…ØªÙ† Ù¾ÛŒØ§Ù…
                    <span style="color: var(--p-error);">*</span>
                </label>
                <textarea id="broadcastMessage" name="message" class="form-control" rows="8" required
                    placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." style="min-height: 200px; line-height: 1.8;"></textarea>
                <div
                    style="display: flex; justify-content: space-between; margin-top: var(--sp-xs); font-size: 0.8rem; color: var(--p-text-muted);">
                    <span>
                        <i class="fas fa-font"></i>
                        <span id="charCount">0</span> Ú©Ø§Ø±Ø§Ú©ØªØ±
                    </span>
                    <span>Ù¾ÛŒØ§Ù… Ø¨Ù‡ ØµÙˆØ±Øª HTML Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯</span>
                </div>
            </div>

            <!-- Preview Section -->
            <div
                style="background: var(--p-bg-hover); border-radius: var(--radius-lg); padding: var(--sp-md); margin-bottom: var(--sp-lg); border: 1px solid var(--border-color);">
                <div
                    style="font-weight: 700; margin-bottom: var(--sp-sm); display: flex; align-items: center; gap: var(--sp-sm);">
                    <i class="fas fa-eye" style="color: var(--p-info);"></i>
                    Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…
                </div>
                <div id="previewContent" style="white-space: pre-wrap; line-height: 1.8; color: var(--p-text-main);">
                    Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯...
                </div>
            </div>

            <!-- Warning -->
            <div class="alert alert-warning" style="margin-bottom: var(--sp-lg);">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <strong>Ù‡Ø´Ø¯Ø§Ø±:</strong>
                    Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø§Ø² Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ØŒ Ù…Ø­ØªÙˆØ§ÛŒ Ù¾ÛŒØ§Ù… Ø±Ø§ Ø¨Ø§ Ø¯Ù‚Øª Ø¨Ø±Ø±Ø³ÛŒ
                    Ú©Ù†ÛŒØ¯.
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end;">
                <button type="submit" class="btn btn-primary" id="sendBtn" style="min-width: 200px;">
                    <i class="fas fa-paper-plane"></i>
                    <span>Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Professional Confirmation Modal -->
<div id="broadcastConfirmModal" class="modal-overlay" style="display: none;">
    <div class="modal-card" style="max-width: 500px;">
        <div class="card-header" style="border-bottom: 1px solid var(--border-color); margin-bottom: var(--sp-lg); padding-bottom: var(--sp-md);">
            <div class="card-title">
                <i class="fas fa-exclamation-triangle" style="color: var(--p-warning);"></i>
                ØªØ£ÛŒÛŒØ¯ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ
            </div>
            <button onclick="closeBroadcastConfirmModal()" class="close-btn"><i class="fas fa-times"></i></button>
        </div>
        <div style="padding: 0 var(--sp-lg);">
            <p style="font-size: 1rem; color: var(--p-text-main); margin-bottom: var(--sp-lg); text-align: center;">
                Ø¢ÛŒØ§ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ
            </p>
            <div style="background: var(--p-bg-hover); border-radius: var(--radius-md); padding: var(--sp-md); margin-bottom: var(--sp-lg);">
                <div style="display: flex; justify-content: space-between; margin-bottom: var(--sp-sm);">
                    <span style="color: var(--p-text-muted);">ğŸ“Š Ú¯Ø±ÙˆÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ:</span>
                    <span style="font-weight: 700; color: var(--p-info);" id="confirmFilterName">-</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: var(--sp-sm);">
                    <span style="color: var(--p-text-muted);">ğŸ‘¥ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:</span>
                    <span style="font-weight: 700; color: var(--p-success);" id="confirmUserCount">-</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding-top: var(--sp-sm); border-top: 1px solid var(--border-color);">
                    <span style="color: var(--p-text-muted);">ğŸ“ Ø·ÙˆÙ„ Ù¾ÛŒØ§Ù…:</span>
                    <span style="font-weight: 700; color: var(--p-text-main);" id="confirmMessageLength">-</span>
                </div>
            </div>
            <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid var(--p-warning); border-radius: var(--radius-md); padding: var(--sp-md); margin-bottom: var(--sp-lg);">
                <div style="font-size: 0.85rem; color: var(--p-warning); font-weight: 700; margin-bottom: var(--sp-xs);">
                    <i class="fas fa-info-circle"></i> Ù†Ú©ØªÙ‡ Ù…Ù‡Ù…:
                </div>
                <ul style="margin: 0; padding-right: var(--sp-lg); font-size: 0.85rem; color: var(--p-text-main); line-height: 1.8;">
                    <li>Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª</li>
                    <li>Ù¾ÛŒØ§Ù… Ø¨Ù‡ ØªÙ…Ø§Ù… Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ú¯Ø±ÙˆÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯</li>
                    <li>Ø²Ù…Ø§Ù† Ø§Ø±Ø³Ø§Ù„ Ø¨Ø³ØªÙ‡ Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø·ÙˆÙ„ Ø¨Ú©Ø´Ø¯</li>
                </ul>
            </div>
            <div style="display: flex; gap: var(--sp-md);">
                <button type="button" class="btn btn-secondary" onclick="closeBroadcastConfirmModal()" style="flex: 1;">Ù„ØºÙˆ</button>
                <button type="button" class="btn btn-primary" onclick="confirmBroadcast()" style="flex: 2;">
                    <i class="fas fa-paper-plane"></i> ØªØ£ÛŒÛŒØ¯ Ùˆ Ø§Ø±Ø³Ø§Ù„
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .filter-option input[type="radio"]:checked + .filter-card,
    .filter-option .filter-card.active {
        background: var(--p-bg-hover);
        border-color: var(--p-primary);
        box-shadow: 0 0 0 2px var(--p-primary);
    }
    
    .filter-card {
        background: var(--p-bg-card);
        border: 2px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: var(--sp-lg);
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .filter-card:hover {
        border-color: var(--border-color-hover);
        transform: translateY(-2px);
    }
    
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(8px);
    }

    .modal-card {
        background: var(--p-bg-main);
        border-radius: var(--radius-xl);
        width: 100%;
        max-width: 500px;
        padding: var(--sp-xl);
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-xl);
        animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script>
    // Update character count and preview
    document.getElementById('broadcastMessage').addEventListener('input', function () {
        const charCount = this.value.length;
        document.getElementById('charCount').textContent = charCount.toLocaleString('fa-IR');
        updatePreview();
    });

    function updatePreview() {
        const content = document.getElementById('broadcastMessage').value;
        document.getElementById('previewContent').textContent = content || 'Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯...';
    }

    let broadcastData = null;

    function updateFilterInfo() {
        const selectedFilter = document.querySelector('input[name="user_filter"]:checked').value;
        const filterNames = {
            'all': 'Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (Ú©Ù„ Ø¯ÛŒØªØ§Ø¨ÛŒØ³)',
            'active': 'Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„ (Ø§Ø´ØªØ±Ø§Ú© ÙØ¹Ø§Ù„ Ø¯Ø§Ø±Ù†Ø¯)',
            'inactive': 'Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ØºÛŒØ±ÙØ¹Ø§Ù„ (Ø§Ø´ØªØ±Ø§Ú© ØªÙ…ÙˆÙ… Ø´Ø¯Ù‡)',
            'no_purchase': 'Ø¨Ø¯ÙˆÙ† Ø®Ø±ÛŒØ¯ (Ù‡Ù†ÙˆØ² Ø®Ø±ÛŒØ¯ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø¯Ø§Ø¯Ù‡â€ŒØ§Ù†Ø¯)'
        };
        
        document.getElementById('filterInfoText').textContent = `Ú¯Ø±ÙˆÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ: ${filterNames[selectedFilter]}`;
        
        // Update filter card active state
        document.querySelectorAll('.filter-card').forEach(card => {
            card.classList.remove('active');
        });
        document.querySelector(`.filter-card[data-filter="${selectedFilter}"]`).classList.add('active');
    }

    async function sendBroadcast(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const message = formData.get('message');
        const userFilter = formData.get('user_filter') || 'all';

        if (!message || !message.trim()) {
            showToast('Ù¾ÛŒØ§Ù… Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯', 'error');
            return;
        }

        // Get user count for selected filter
        try {
            const countResponse = await apiCall('/api/admin/broadcast/count', {
                method: 'POST',
                body: JSON.stringify({ filter: userFilter })
            });
            
            const filterNames = {
                'all': 'Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†',
                'active': 'Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„',
                'inactive': 'Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ØºÛŒØ±ÙØ¹Ø§Ù„',
                'no_purchase': 'Ø¨Ø¯ÙˆÙ† Ø®Ø±ÛŒØ¯'
            };
            
            document.getElementById('confirmFilterName').textContent = filterNames[userFilter];
            document.getElementById('confirmUserCount').textContent = (countResponse.count || 0).toLocaleString('fa-IR') + ' Ù†ÙØ±';
            document.getElementById('confirmMessageLength').textContent = message.trim().length.toLocaleString('fa-IR') + ' Ú©Ø§Ø±Ø§Ú©ØªØ±';
            
            broadcastData = {
                message: message.trim(),
                filter: userFilter
            };
            
            document.getElementById('broadcastConfirmModal').style.display = 'flex';
        } catch (error) {
            console.error('Error getting user count:', error);
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†', 'error');
        }
    }

    function closeBroadcastConfirmModal() {
        document.getElementById('broadcastConfirmModal').style.display = 'none';
        broadcastData = null;
    }

    async function confirmBroadcast() {
        if (!broadcastData) return;
        
        const sendBtn = document.getElementById('sendBtn');
        const originalText = sendBtn.innerHTML;
        
        closeBroadcastConfirmModal();
        
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...</span>';

        try {
            showToast('Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…...', 'info');

            const response = await apiCall('/api/admin/broadcast', {
                method: 'POST',
                body: JSON.stringify({
                    message: broadcastData.message,
                    filter: broadcastData.filter,
                    type: 'message'
                })
            });

            if (response.success) {
                const successMsg = `${response.message || 'Ù¾ÛŒØ§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯'} - Ù…ÙˆÙÙ‚: ${response.success_count || 0}, Ù†Ø§Ù…ÙˆÙÙ‚: ${response.failed_count || 0}`;
                showToast(successMsg, 'success');
                document.getElementById('broadcastForm').reset();
                updatePreview();
                document.getElementById('charCount').textContent = '0';
                updateFilterInfo();
            } else {
                showToast(response.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast(error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…', 'error');
        } finally {
            sendBtn.disabled = false;
            sendBtn.innerHTML = originalText;
        }
    }
    
    // Initialize filter info
    updateFilterInfo();

    // Initialize preview
    updatePreview();
</script>
{% endblock %}